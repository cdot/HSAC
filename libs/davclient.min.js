if(typeof dav==="undefined"){dav={}}dav._XML_CHAR_MAP={"<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","'":"&apos;"};dav._escapeXml=function(s){return s.replace(/[<>&"']/g,function(ch){return dav._XML_CHAR_MAP[ch]})};dav.Client=function(options){var i;for(i in options){this[i]=options[i]}};dav.Client.prototype={baseUrl:null,userName:null,password:null,xmlNamespaces:{"DAV:":"d"},propFind:function(url,properties,depth,headers){if(typeof depth==="undefined"){depth="0"}depth=""+depth;headers=headers||{};headers["Depth"]=depth;headers["Content-Type"]="application/xml; charset=utf-8";var body='<?xml version="1.0"?>\n'+"<d:propfind ";var namespace;for(namespace in this.xmlNamespaces){body+=" xmlns:"+this.xmlNamespaces[namespace]+'="'+namespace+'"'}body+=">\n"+"  <d:prop>\n";for(var ii in properties){if(!properties.hasOwnProperty(ii)){continue}var property=this.parseClarkNotation(properties[ii]);if(this.xmlNamespaces[property.namespace]){body+="    <"+this.xmlNamespaces[property.namespace]+":"+property.name+" />\n"}else{body+="    <x:"+property.name+' xmlns:x="'+property.namespace+'" />\n'}}body+="  </d:prop>\n";body+="</d:propfind>";return this.request("PROPFIND",url,headers,body).then(function(result){if(depth==="0"){return{status:result.status,body:result.body[0],xhr:result.xhr}}else{return{status:result.status,body:result.body,xhr:result.xhr}}}.bind(this))},_renderPropSet:function(properties){var body="  <d:set>\n"+"   <d:prop>\n";for(var ii in properties){if(!properties.hasOwnProperty(ii)){continue}var property=this.parseClarkNotation(ii);var propName;var propValue=properties[ii];if(this.xmlNamespaces[property.namespace]){propName=this.xmlNamespaces[property.namespace]+":"+property.name}else{propName="x:"+property.name+' xmlns:x="'+property.namespace+'"'}if(propName!=="d:resourcetype"){propValue=dav._escapeXml(propValue)}body+="      <"+propName+">"+propValue+"</"+propName+">\n"}body+="    </d:prop>\n";body+="  </d:set>\n";return body},propPatch:function(url,properties,headers){headers=headers||{};headers["Content-Type"]="application/xml; charset=utf-8";var body='<?xml version="1.0"?>\n'+"<d:propertyupdate ";var namespace;for(namespace in this.xmlNamespaces){body+=" xmlns:"+this.xmlNamespaces[namespace]+'="'+namespace+'"'}body+=">\n"+this._renderPropSet(properties);body+="</d:propertyupdate>";return this.request("PROPPATCH",url,headers,body).then(function(result){return{status:result.status,body:result.body,xhr:result.xhr}}.bind(this))},mkcol:function(url,properties,headers){var body="";headers=headers||{};headers["Content-Type"]="application/xml; charset=utf-8";if(properties){body='<?xml version="1.0"?>\n'+"<d:mkcol";var namespace;for(namespace in this.xmlNamespaces){body+=" xmlns:"+this.xmlNamespaces[namespace]+'="'+namespace+'"'}body+=">\n"+this._renderPropSet(properties);body+="</d:mkcol>"}return this.request("MKCOL",url,headers,body).then(function(result){return{status:result.status,body:result.body,xhr:result.xhr}}.bind(this))},request:function(method,url,headers,body){var self=this;var xhr=this.xhrProvider();headers=headers||{};if(this.userName){headers["Authorization"]="Basic "+btoa(this.userName+":"+this.password)}var turl=new URL(url,this.baseUrl).toString();xhr.open(method,turl,true);var ii;for(ii in headers){xhr.setRequestHeader(ii,headers[ii])}if(body===undefined){xhr.send()}else{xhr.send(body)}return new Promise(function(fulfill,reject){xhr.onreadystatechange=function(){if(xhr.readyState!==4){return}var resultBody=xhr.response;if(xhr.status===207){resultBody=self.parseMultiStatus(xhr.response)}fulfill({body:resultBody,status:xhr.status,xhr:xhr})};xhr.ontimeout=function(){reject(new Error("Timeout exceeded"))}})},xhrProvider:function(){return new XMLHttpRequest},_parsePropNode:function(propNode){var content=null;if(propNode.childNodes&&propNode.childNodes.length>0){var subNodes=[];for(var j=0;j<propNode.childNodes.length;j++){var node=propNode.childNodes[j];if(node.nodeType===1){subNodes.push(node)}}if(subNodes.length){content=subNodes}}return content||propNode.textContent||propNode.text||""},parseMultiStatus:function(xmlBody){var parser=new DOMParser;var doc=parser.parseFromString(xmlBody,"application/xml");var resolver=function(foo){var ii;for(ii in this.xmlNamespaces){if(this.xmlNamespaces[ii]===foo){return ii}}}.bind(this);var responseIterator=doc.evaluate("/d:multistatus/d:response",doc,resolver,XPathResult.ANY_TYPE,null);var result=[];var responseNode=responseIterator.iterateNext();while(responseNode){var response={href:null,propStat:[]};response.href=doc.evaluate("string(d:href)",responseNode,resolver,XPathResult.ANY_TYPE,null).stringValue;var propStatIterator=doc.evaluate("d:propstat",responseNode,resolver,XPathResult.ANY_TYPE,null);var propStatNode=propStatIterator.iterateNext();while(propStatNode){var propStat={status:doc.evaluate("string(d:status)",propStatNode,resolver,XPathResult.ANY_TYPE,null).stringValue,properties:{}};var propIterator=doc.evaluate("d:prop/*",propStatNode,resolver,XPathResult.ANY_TYPE,null);var propNode=propIterator.iterateNext();while(propNode){var content=this._parsePropNode(propNode);propStat.properties["{"+propNode.namespaceURI+"}"+propNode.localName]=content;propNode=propIterator.iterateNext()}response.propStat.push(propStat);propStatNode=propStatIterator.iterateNext()}result.push(response);responseNode=responseIterator.iterateNext()}return result},parseClarkNotation:function(propertyName){var result=propertyName.match(/^{([^}]+)}(.*)$/);if(!result){return}return{name:result[2],namespace:result[1]}}};if(typeof module!=="undefined"&&typeof module.exports!=="undefined"){module.exports.Client=dav.Client}
